import 'dart:io';
import 'package:flutter/material.dart';
import 'package:google_fonts/google_fonts.dart';
import 'package:image_picker/image_picker.dart';
import 'package:video_player/video_player.dart';
import 'package:firebase_auth/firebase_auth.dart';
import '../models/product.dart';
import '../services/product_service.dart';
import '../services/gemini_service.dart';
import 'package:form_validator/form_validator.dart';

class ProductListingPage extends StatefulWidget {
  const ProductListingPage({Key? key}) : super(key: key);

  @override
  State<ProductListingPage> createState() => _ProductListingPageState();
}

class _ProductListingPageState extends State<ProductListingPage> {
  final _formKey = GlobalKey<FormState>();
  final _productService = ProductService();
  final _imagePicker = ImagePicker();

  // Form controllers
  final _nameController = TextEditingController();
  final _priceController = TextEditingController();
  final _stockController = TextEditingController();
  final _descriptionController = TextEditingController();
  final _materialsController = TextEditingController();
  final _dimensionsController = TextEditingController();
  final _craftingTimeController = TextEditingController();
  final _careInstructionsController = TextEditingController();

  // Media handling
  List<File> _selectedImages = [];
  File? _selectedVideo;
  VideoPlayerController? _videoController;
  bool _useVideo = false;

  // AI Analysis
  bool _isAnalyzing = false;
  bool _hasAnalyzed = false;

  // Categories
  String _selectedCategory = 'Pottery';
  final List<String> _categories = [
    'Pottery',
    'Jewelry',
    'Textiles',
    'Woodwork',
    'Metalwork',
    'Leather Goods',
    'Glass Art',
    'Stone Carving',
    'Basketry',
    'Ceramics',
    'Sculpture',
    'Other'
  ];

  // Loading state
  bool _isSubmitting = false;

  // Colors (matching the luxury theme)
  static const Color primaryBrown = Color(0xFF2C1810);
  static const Color accentGold = Color(0xFFD4AF37);
  static const Color lightBrown = Color(0xFF8B5A2B);

  @override
  void dispose() {
    _videoController?.dispose();
    _nameController.dispose();
    _priceController.dispose();
    _stockController.dispose();
    _descriptionController.dispose();
    _materialsController.dispose();
    _dimensionsController.dispose();
    _craftingTimeController.dispose();
    _careInstructionsController.dispose();
    super.dispose();
  }

  // Pick images from gallery
  Future<void> _pickImages() async {
    final List<XFile> images = await _imagePicker.pickMultiImage();
    
    if (images.isNotEmpty) {
      setState(() {
        _selectedImages = images.map((image) => File(image.path)).toList();
        _useVideo = false;
        _selectedVideo = null;
        _videoController?.dispose();
        _videoController = null;
        _hasAnalyzed = false;
      });
    }
  }

  // Pick video from gallery
  Future<void> _pickVideo() async {
    final XFile? video = await _imagePicker.pickVideo(source: ImageSource.gallery);
    
    if (video != null) {
      setState(() {
        _selectedVideo = File(video.path);
        _useVideo = true;
        _selectedImages.clear();
        _hasAnalyzed = false;
      });
      
      _initializeVideoPlayer();
    }
  }

  // Initialize video player
  void _initializeVideoPlayer() {
    if (_selectedVideo != null) {
      _videoController = VideoPlayerController.file(_selectedVideo!)
        ..initialize().then((_) {
          setState(() {});
        });
    }
  }

  // Analyze media with Gemini AI
  Future<void> _analyzeWithAI() async {
    if ((_selectedImages.isEmpty && _selectedVideo == null)) {
      _showSnackBar('Please select images or video first', isError: true);
      return;
    }

    setState(() {
      _isAnalyzing = true;
    });

    try {
      Map<String, dynamic> analysis;
      
      if (_useVideo && _selectedVideo != null) {
        analysis = await GeminiService.extractProductDetailsFromVideo(_selectedVideo!);
      } else {
        analysis = await GeminiService.extractProductDetails(_selectedImages);
      }

      // Populate form with AI analysis
      _nameController.text = analysis['name'] ?? '';
      _descriptionController.text = analysis['description'] ?? '';
      
      if (analysis['category'] != null && _categories.contains(analysis['category'])) {
        _selectedCategory = analysis['category'];
      }
      
      _materialsController.text = (analysis['materials'] as List?)?.join(', ') ?? '';
      _craftingTimeController.text = analysis['craftingTime'] ?? '';
      _dimensionsController.text = analysis['dimensions'] ?? '';
      _priceController.text = analysis['suggestedPrice']?.toString() ?? '';
      _careInstructionsController.text = analysis['careInstructions'] ?? '';

      setState(() {
        _hasAnalyzed = true;
      });

      _showSnackBar('Product details analyzed successfully!');
    } catch (e) {
      _showSnackBar('Error analyzing product: ${e.toString()}', isError: true);
    } finally {
      setState(() {
        _isAnalyzing = false;
      });
    }
  }

  // Submit product listing
  Future<void> _submitProduct() async {
    if (!_formKey.currentState!.validate()) {
      return;
    }

    if (_selectedImages.length < 4 && _selectedVideo == null) {
      _showSnackBar('Please upload at least 4 images or 1 video', isError: true);
      return;
    }

    setState(() {
      _isSubmitting = true;
    });

    try {
      final user = FirebaseAuth.instance.currentUser;
      if (user == null) {
        throw Exception('User not authenticated');
      }

      // Upload media files
      List<String> imageUrls = [];
      String? videoUrl;

      if (_useVideo && _selectedVideo != null) {
        videoUrl = await _productService.uploadVideo(_selectedVideo!);
      } else {
        imageUrls = await _productService.uploadImages(_selectedImages);
      }

      // Create product
      final product = Product(
        id: DateTime.now().millisecondsSinceEpoch.toString(),
        artisanId: user.uid,
        name: _nameController.text.trim(),
        description: _descriptionController.text.trim(),
        category: _selectedCategory,
        price: double.parse(_priceController.text),
        materials: _materialsController.text.split(',').map((m) => m.trim()).toList(),
        craftingTime: _craftingTimeController.text.trim(),
        dimensions: _dimensionsController.text.trim(),
        imageUrls: imageUrls,
        videoUrl: videoUrl,
        createdAt: DateTime.now(),
        stockQuantity: int.tryParse(_stockController.text) ?? 1,
        tags: _generateTags(),
      );

      await _productService.createProduct(product);
      
      _showSnackBar('Product listed successfully!');
      _clearForm();
      
    } catch (e) {
      _showSnackBar('Error creating product: ${e.toString()}', isError: true);
    } finally {
      setState(() {
        _isSubmitting = false;
      });
    }
  }

  // Generate tags based on product details
  List<String> _generateTags() {
    final tags = <String>[];
    tags.add(_selectedCategory.toLowerCase());
    tags.add('handmade');
    tags.add('artisan');
    
    // Add material-based tags
    final materials = _materialsController.text.toLowerCase();
    if (materials.contains('wood')) tags.add('wooden');
    if (materials.contains('clay')) tags.add('ceramic');
    if (materials.contains('metal')) tags.add('metal');
    if (materials.contains('glass')) tags.add('glass');
    if (materials.contains('fabric')) tags.add('textile');
    
    return tags.take(10).toList();
  }

  // Clear form
  void _clearForm() {
    _formKey.currentState?.reset();
    _nameController.clear();
    _priceController.clear();
    _stockController.clear();
    _descriptionController.clear();
    _materialsController.clear();
    _dimensionsController.clear();
    _craftingTimeController.clear();
    _careInstructionsController.clear();
    
    setState(() {
      _selectedImages.clear();
      _selectedVideo = null;
      _videoController?.dispose();
      _videoController = null;
      _useVideo = false;
      _hasAnalyzed = false;
      _selectedCategory = 'Pottery';
    });
  }

  // Show snackbar
  void _showSnackBar(String message, {bool isError = false}) {
    ScaffoldMessenger.of(context).showSnackBar(
      SnackBar(
        content: Text(message),
        backgroundColor: isError ? Colors.red : accentGold,
        duration: Duration(seconds: 3),
      ),
    );
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.grey[50],
      appBar: AppBar(
        title: Text(
          'List Your Product',
          style: GoogleFonts.playfairDisplay(
            fontSize: 24,
            fontWeight: FontWeight.bold,
            color: Colors.white,
          ),
        ),
        backgroundColor: primaryBrown,
        elevation: 0,
        centerTitle: true,
      ),
      body: Form(
        key: _formKey,
        child: SingleChildScrollView(
          padding: const EdgeInsets.all(20.0),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              _buildMediaSection(),
              const SizedBox(height: 30),
              _buildAIAnalysisSection(),
              const SizedBox(height: 30),
              _buildProductDetailsSection(),
              const SizedBox(height: 40),
              _buildSubmitButton(),
            ],
          ),
        ),
      ),
    );
  }

  Widget _buildMediaSection() {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(15),
        boxShadow: [
          BoxShadow(
            color: Colors.grey.withOpacity(0.1),
            spreadRadius: 0,
            blurRadius: 10,
            offset: const Offset(0, 5),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Product Media',
            style: GoogleFonts.playfairDisplay(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: primaryBrown,
            ),
          ),
          const SizedBox(height: 10),
          Text(
            'Upload at least 4 high-quality photos or 1 comprehensive video showcasing your product from all angles',
            style: GoogleFonts.inter(
              fontSize: 14,
              color: Colors.grey[600],
            ),
          ),
          const SizedBox(height: 20),
          
          // Media type selection
          Row(
            children: [
              Expanded(
                child: ElevatedButton.icon(
                  onPressed: _pickImages,
                  icon: const Icon(Icons.photo_library),
                  label: Text('Select Photos'),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: _useVideo ? Colors.grey[300] : lightBrown,
                    foregroundColor: _useVideo ? Colors.grey[700] : Colors.white,
                    padding: const EdgeInsets.symmetric(vertical: 12),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(10),
                    ),
                  ),
                ),
              ),
              const SizedBox(width: 15),
              Expanded(
                child: ElevatedButton.icon(
                  onPressed: _pickVideo,
                  icon: const Icon(Icons.videocam),
                  label: Text('Select Video'),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: !_useVideo ? Colors.grey[300] : lightBrown,
                    foregroundColor: !_useVideo ? Colors.grey[700] : Colors.white,
                    padding: const EdgeInsets.symmetric(vertical: 12),
                    shape: RoundedRectangleBorder(
                      borderRadius: BorderRadius.circular(10),
                    ),
                  ),
                ),
              ),
            ],
          ),
          
          const SizedBox(height: 20),
          
          // Display selected media
          if (_selectedImages.isNotEmpty) _buildImagePreview(),
          if (_selectedVideo != null && _useVideo) _buildVideoPreview(),
          
          // Validation message
          if (_selectedImages.length < 4 && _selectedVideo == null)
            Container(
              margin: const EdgeInsets.only(top: 10),
              padding: const EdgeInsets.all(10),
              decoration: BoxDecoration(
                color: Colors.orange[50],
                borderRadius: BorderRadius.circular(8),
                border: Border.all(color: Colors.orange[200]!),
              ),
              child: Row(
                children: [
                  Icon(Icons.warning_amber, color: Colors.orange[700], size: 20),
                  const SizedBox(width: 10),
                  Expanded(
                    child: Text(
                      _selectedImages.isEmpty && _selectedVideo == null
                          ? 'Please select media files'
                          : 'Need ${4 - _selectedImages.length} more photos or switch to video',
                      style: TextStyle(color: Colors.orange[700], fontSize: 12),
                    ),
                  ),
                ],
              ),
            ),
        ],
      ),
    );
  }

  Widget _buildImagePreview() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          '${_selectedImages.length} Photos Selected',
          style: GoogleFonts.inter(
            fontWeight: FontWeight.w600,
            color: primaryBrown,
          ),
        ),
        const SizedBox(height: 10),
        SizedBox(
          height: 100,
          child: ListView.builder(
            scrollDirection: Axis.horizontal,
            itemCount: _selectedImages.length,
            itemBuilder: (context, index) {
              return Container(
                width: 100,
                height: 100,
                margin: const EdgeInsets.only(right: 10),
                decoration: BoxDecoration(
                  borderRadius: BorderRadius.circular(10),
                  border: Border.all(color: Colors.grey[300]!),
                ),
                child: ClipRRect(
                  borderRadius: BorderRadius.circular(10),
                  child: Image.file(
                    _selectedImages[index],
                    fit: BoxFit.cover,
                  ),
                ),
              );
            },
          ),
        ),
      ],
    );
  }

  Widget _buildVideoPreview() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Video Selected',
          style: GoogleFonts.inter(
            fontWeight: FontWeight.w600,
            color: primaryBrown,
          ),
        ),
        const SizedBox(height: 10),
        Container(
          height: 200,
          width: double.infinity,
          decoration: BoxDecoration(
            borderRadius: BorderRadius.circular(10),
            border: Border.all(color: Colors.grey[300]!),
          ),
          child: _videoController != null && _videoController!.value.isInitialized
              ? ClipRRect(
                  borderRadius: BorderRadius.circular(10),
                  child: AspectRatio(
                    aspectRatio: _videoController!.value.aspectRatio,
                    child: VideoPlayer(_videoController!),
                  ),
                )
              : const Center(
                  child: CircularProgressIndicator(),
                ),
        ),
      ],
    );
  }

  Widget _buildAIAnalysisSection() {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        gradient: LinearGradient(
          colors: [accentGold.withOpacity(0.1), Colors.white],
          begin: Alignment.topLeft,
          end: Alignment.bottomRight,
        ),
        borderRadius: BorderRadius.circular(15),
        border: Border.all(color: accentGold.withOpacity(0.3)),
      ),
      child: Column(
        children: [
          Row(
            children: [
              Icon(Icons.auto_awesome, color: accentGold, size: 28),
              const SizedBox(width: 10),
              Expanded(
                child: Text(
                  'AI-Powered Product Analysis',
                  style: GoogleFonts.playfairDisplay(
                    fontSize: 18,
                    fontWeight: FontWeight.bold,
                    color: primaryBrown,
                  ),
                ),
              ),
            ],
          ),
          const SizedBox(height: 10),
          Text(
            'Let our AI analyze your photos or video to automatically generate product details, saving you time and ensuring comprehensive descriptions.',
            style: GoogleFonts.inter(
              fontSize: 14,
              color: Colors.grey[700],
            ),
            textAlign: TextAlign.center,
          ),
          const SizedBox(height: 20),
          SizedBox(
            width: double.infinity,
            child: ElevatedButton.icon(
              onPressed: (_selectedImages.isNotEmpty || _selectedVideo != null) && !_isAnalyzing
                  ? _analyzeWithAI
                  : null,
              icon: _isAnalyzing
                  ? SizedBox(
                      width: 20,
                      height: 20,
                      child: CircularProgressIndicator(
                        strokeWidth: 2,
                        valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                      ),
                    )
                  : Icon(Icons.psychology),
              label: Text(_isAnalyzing ? 'Analyzing...' : 'Analyze with AI'),
              style: ElevatedButton.styleFrom(
                backgroundColor: accentGold,
                foregroundColor: Colors.white,
                padding: const EdgeInsets.symmetric(vertical: 15),
                shape: RoundedRectangleBorder(
                  borderRadius: BorderRadius.circular(10),
                ),
              ),
            ),
          ),
          if (_hasAnalyzed)
            Padding(
              padding: const EdgeInsets.only(top: 15),
              child: Container(
                padding: const EdgeInsets.all(10),
                decoration: BoxDecoration(
                  color: Colors.green[50],
                  borderRadius: BorderRadius.circular(8),
                  border: Border.all(color: Colors.green[200]!),
                ),
                child: Row(
                  children: [
                    Icon(Icons.check_circle, color: Colors.green[700], size: 20),
                    const SizedBox(width: 10),
                    Expanded(
                      child: Text(
                        'Analysis complete! Review and edit the details below.',
                        style: TextStyle(color: Colors.green[700], fontSize: 12),
                      ),
                    ),
                  ],
                ),
              ),
            ),
        ],
      ),
    );
  }

  Widget _buildProductDetailsSection() {
    return Container(
      padding: const EdgeInsets.all(20),
      decoration: BoxDecoration(
        color: Colors.white,
        borderRadius: BorderRadius.circular(15),
        boxShadow: [
          BoxShadow(
            color: Colors.grey.withOpacity(0.1),
            spreadRadius: 0,
            blurRadius: 10,
            offset: const Offset(0, 5),
          ),
        ],
      ),
      child: Column(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          Text(
            'Product Details',
            style: GoogleFonts.playfairDisplay(
              fontSize: 20,
              fontWeight: FontWeight.bold,
              color: primaryBrown,
            ),
          ),
          const SizedBox(height: 20),
          
          // Product Name
          _buildTextField(
            controller: _nameController,
            label: 'Product Name',
            hint: 'Enter a descriptive name for your product',
            validator: ValidationBuilder().minLength(3).maxLength(100).build(),
          ),
          
          const SizedBox(height: 20),
          
          // Category
          _buildCategoryDropdown(),
          
          const SizedBox(height: 20),
          
          // Price and Stock
          Row(
            children: [
              Expanded(
                child: _buildTextField(
                  controller: _priceController,
                  label: 'Price (USD)',
                  hint: '0.00',
                  keyboardType: TextInputType.number,
                  validator: ValidationBuilder()
                      .required()
                      .regExp(RegExp(r'^\d+\.?\d{0,2}$'), 'Enter valid price')
                      .build(),
                ),
              ),
              const SizedBox(width: 15),
              Expanded(
                child: _buildTextField(
                  controller: _stockController,
                  label: 'Stock Quantity',
                  hint: '1',
                  keyboardType: TextInputType.number,
                  validator: ValidationBuilder()
                      .required()
                      .regExp(RegExp(r'^\d+$'), 'Enter valid quantity')
                      .build(),
                ),
              ),
            ],
          ),
          
          const SizedBox(height: 20),
          
          // Description
          _buildTextField(
            controller: _descriptionController,
            label: 'Description',
            hint: 'Describe your product, materials, techniques, and what makes it special',
            maxLines: 4,
            validator: ValidationBuilder().minLength(50).maxLength(1000).build(),
          ),
          
          const SizedBox(height: 20),
          
          // Materials
          _buildTextField(
            controller: _materialsController,
            label: 'Materials Used',
            hint: 'e.g., Oak wood, Natural leather, Sterling silver',
            validator: ValidationBuilder().required().build(),
          ),
          
          const SizedBox(height: 20),
          
          // Dimensions and Crafting Time
          Row(
            children: [
              Expanded(
                child: _buildTextField(
                  controller: _dimensionsController,
                  label: 'Dimensions',
                  hint: 'e.g., 15cm x 10cm x 5cm',
                  validator: ValidationBuilder().required().build(),
                ),
              ),
              const SizedBox(width: 15),
              Expanded(
                child: _buildTextField(
                  controller: _craftingTimeController,
                  label: 'Crafting Time',
                  hint: 'e.g., 3-5 days',
                  validator: ValidationBuilder().required().build(),
                ),
              ),
            ],
          ),
          
          const SizedBox(height: 20),
          
          // Care Instructions
          _buildTextField(
            controller: _careInstructionsController,
            label: 'Care Instructions',
            hint: 'How should customers care for this product?',
            maxLines: 2,
          ),
        ],
      ),
    );
  }

  Widget _buildTextField({
    required TextEditingController controller,
    required String label,
    required String hint,
    int maxLines = 1,
    TextInputType keyboardType = TextInputType.text,
    String? Function(String?)? validator,
  }) {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          label,
          style: GoogleFonts.inter(
            fontWeight: FontWeight.w600,
            color: primaryBrown,
          ),
        ),
        const SizedBox(height: 8),
        TextFormField(
          controller: controller,
          maxLines: maxLines,
          keyboardType: keyboardType,
          validator: validator,
          style: GoogleFonts.inter(),
          decoration: InputDecoration(
            hintText: hint,
            hintStyle: GoogleFonts.inter(color: Colors.grey[400]),
            filled: true,
            fillColor: Colors.grey[50],
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide(color: Colors.grey[300]!),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide(color: Colors.grey[300]!),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide(color: lightBrown, width: 2),
            ),
            errorBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide(color: Colors.red, width: 1),
            ),
            contentPadding: const EdgeInsets.symmetric(horizontal: 15, vertical: 12),
          ),
        ),
      ],
    );
  }

  Widget _buildCategoryDropdown() {
    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Text(
          'Category',
          style: GoogleFonts.inter(
            fontWeight: FontWeight.w600,
            color: primaryBrown,
          ),
        ),
        const SizedBox(height: 8),
        DropdownButtonFormField<String>(
          value: _selectedCategory,
          decoration: InputDecoration(
            filled: true,
            fillColor: Colors.grey[50],
            border: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide(color: Colors.grey[300]!),
            ),
            enabledBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide(color: Colors.grey[300]!),
            ),
            focusedBorder: OutlineInputBorder(
              borderRadius: BorderRadius.circular(10),
              borderSide: BorderSide(color: lightBrown, width: 2),
            ),
            contentPadding: const EdgeInsets.symmetric(horizontal: 15, vertical: 12),
          ),
          items: _categories.map((String category) {
            return DropdownMenuItem<String>(
              value: category,
              child: Text(category, style: GoogleFonts.inter()),
            );
          }).toList(),
          onChanged: (String? newValue) {
            setState(() {
              _selectedCategory = newValue!;
            });
          },
        ),
      ],
    );
  }

  Widget _buildSubmitButton() {
    return SizedBox(
      width: double.infinity,
      child: ElevatedButton(
        onPressed: _isSubmitting ? null : _submitProduct,
        style: ElevatedButton.styleFrom(
          backgroundColor: primaryBrown,
          foregroundColor: Colors.white,
          padding: const EdgeInsets.symmetric(vertical: 18),
          shape: RoundedRectangleBorder(
            borderRadius: BorderRadius.circular(12),
          ),
          elevation: 2,
        ),
        child: _isSubmitting
            ? Row(
                mainAxisAlignment: MainAxisAlignment.center,
                children: [
                  SizedBox(
                    width: 20,
                    height: 20,
                    child: CircularProgressIndicator(
                      strokeWidth: 2,
                      valueColor: AlwaysStoppedAnimation<Color>(Colors.white),
                    ),
                  ),
                  const SizedBox(width: 15),
                  Text(
                    'Creating Product...',
                    style: GoogleFonts.inter(
                      fontSize: 16,
                      fontWeight: FontWeight.w600,
                    ),
                  ),
                ],
              )
            : Text(
                'List Product',
                style: GoogleFonts.inter(
                  fontSize: 16,
                  fontWeight: FontWeight.w600,
                ),
              ),
      ),
    );
  }
}
